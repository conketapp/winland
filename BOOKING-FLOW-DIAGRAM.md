# Booking Expiry Flow Diagram

## Complete System Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         BOOKING LIFECYCLE FLOW                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: CREATE BOOKING                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Action:
  â””â”€> Fills booking form (customer info, visit date/time)
       â””â”€> Clicks "Táº¡o booking"

API: POST /api/bookings/create
  â”œâ”€> Generate booking code: BK000001 (based on count)
  â”œâ”€> Calculate expiry: visitEndTime + 30 minutes
  â”œâ”€> Create booking record
  â”‚   â”œâ”€> status: CONFIRMED
  â”‚   â”œâ”€> expiresAt: visitEndTime + 30 min
  â”‚   â””â”€> notes: "Lá»‹ch xem nhÃ : [date] tá»« [start] Ä‘áº¿n [end]"
  â””â”€> Update unit status: RESERVED_BOOKING

Database State:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Booking                             â”‚
  â”‚ â”œâ”€ id: uuid                         â”‚
  â”‚ â”œâ”€ code: BK000001                   â”‚
  â”‚ â”œâ”€ status: CONFIRMED                â”‚
  â”‚ â”œâ”€ expiresAt: 2025-11-20 15:30     â”‚
  â”‚ â””â”€ notes: "Lá»‹ch xem nhÃ ..."        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Unit                                â”‚
  â”‚ â”œâ”€ id: uuid                         â”‚
  â”‚ â”œâ”€ code: A-01-05                    â”‚
  â”‚ â””â”€ status: RESERVED_BOOKING         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dashboard Display:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ðŸ“… Booking                          â”‚
  â”‚ Unit: A-01-05  [âœ“ ÄÃ£ xÃ¡c nháº­n]    â”‚
  â”‚ Customer: Nguyá»…n VÄƒn A             â”‚
  â”‚ Visit: 20/11/2025 â€¢ 14:00-15:00   â”‚
  â”‚ [Xem chi tiáº¿t]                     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: TIME PASSES - BOOKING EXPIRES                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Trigger:
  â””â”€> User refreshes dashboard
       â””â”€> Dashboard calls check-expired API

API: POST /api/bookings/check-expired
  â”œâ”€> Find all CONFIRMED bookings
  â”œâ”€> Check if visitEndTime + 30 min < now
  â”œâ”€> Update expired bookings
  â”‚   â”œâ”€> status: EXPIRED
  â”‚   â””â”€> cancelledReason: "ÄÃ£ qua thá»i gian booking"
  â””â”€> Unit status: RESERVED_BOOKING (NOT CHANGED!)

Database State:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Booking                             â”‚
  â”‚ â”œâ”€ id: uuid                         â”‚
  â”‚ â”œâ”€ code: BK000001                   â”‚
  â”‚ â”œâ”€ status: EXPIRED â† Changed        â”‚
  â”‚ â”œâ”€ expiresAt: 2025-11-20 15:30     â”‚
  â”‚ â”œâ”€ cancelledReason: "ÄÃ£ qua..."    â”‚
  â”‚ â””â”€ notes: "Lá»‹ch xem nhÃ ..."        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Unit                                â”‚
  â”‚ â”œâ”€ id: uuid                         â”‚
  â”‚ â”œâ”€ code: A-01-05                    â”‚
  â”‚ â””â”€ status: RESERVED_BOOKING â† Same â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dashboard Display:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ðŸ“… Booking                          â”‚
  â”‚ Unit: A-01-05  [â± Háº¿t háº¡n]        â”‚
  â”‚ Customer: Nguyá»…n VÄƒn A             â”‚
  â”‚ Visit: 20/11/2025 â€¢ 14:00-15:00   â”‚
  â”‚ [Xem chi tiáº¿t]         [ðŸ—‘ï¸ Trash] â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: USER CLICKS TRASH BUTTON                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Action:
  â””â”€> Clicks Trash button
       â””â”€> Confirmation dialog appears
            â””â”€> User confirms deletion

API: DELETE /api/bookings/[id]
  â”œâ”€> Verify booking status (must be EXPIRED/COMPLETED/CANCELLED)
  â”œâ”€> Add hidden marker to notes
  â”‚   â””â”€> notes: "Lá»‹ch xem nhÃ ...\n[HIDDEN_FROM_DASHBOARD]"
  â”œâ”€> Check for active transactions
  â”‚   â”œâ”€> Count active bookings (CONFIRMED, PENDING_APPROVAL)
  â”‚   â”œâ”€> Count active reservations (ACTIVE, YOUR_TURN)
  â”‚   â””â”€> Count active deposits (PENDING_APPROVAL, CONFIRMED)
  â””â”€> If all counts = 0:
       â””â”€> Update unit status: AVAILABLE

Database State:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Booking                             â”‚
  â”‚ â”œâ”€ id: uuid                         â”‚
  â”‚ â”œâ”€ code: BK000001                   â”‚
  â”‚ â”œâ”€ status: EXPIRED â† Unchanged     â”‚
  â”‚ â”œâ”€ expiresAt: 2025-11-20 15:30     â”‚
  â”‚ â”œâ”€ cancelledReason: "ÄÃ£ qua..."    â”‚
  â”‚ â””â”€ notes: "...\n[HIDDEN_FROM_...]" â”‚â† Added marker
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Unit                                â”‚
  â”‚ â”œâ”€ id: uuid                         â”‚
  â”‚ â”œâ”€ code: A-01-05                    â”‚
  â”‚ â””â”€ status: AVAILABLE â† Changed     â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Dashboard Display:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ (Booking hidden - not displayed)    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Transaction History Display:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ðŸ“… Booking  [â± Háº¿t háº¡n]            â”‚
  â”‚ MÃ£: BK000001                       â”‚
  â”‚ KhÃ¡ch hÃ ng: Nguyá»…n VÄƒn A          â”‚
  â”‚ CÄƒn há»™: A-01-05                    â”‚
  â”‚ ðŸ• 20/11/2025 14:30                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: CREATE NEW BOOKING (SEQUENTIAL ID)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Action:
  â””â”€> Creates another booking on any unit

API: POST /api/bookings/create
  â”œâ”€> Count ALL bookings (including hidden): 1
  â”œâ”€> Generate next code: BK000002 â† Sequential!
  â””â”€> Create new booking

Database State:
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Booking 1 (Hidden)                  â”‚
  â”‚ â”œâ”€ code: BK000001                   â”‚
  â”‚ â””â”€ notes: "...[HIDDEN_FROM_...]"   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Booking 2 (New)                     â”‚
  â”‚ â”œâ”€ code: BK000002 â† No gaps!       â”‚
  â”‚ â””â”€ status: CONFIRMED                â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Multi-Transaction Safety Check

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO: Multiple Transactions on Same Unit                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Initial State:
  Unit A-01-05: AVAILABLE

Step 1: Create Reservation
  â”œâ”€> Reservation created
  â””â”€> Unit A-01-05: RESERVED_BOOKING

Step 2: Create Booking (same unit)
  â”œâ”€> Booking created
  â””â”€> Unit A-01-05: RESERVED_BOOKING (already reserved)

Step 3: Booking Expires
  â”œâ”€> Booking status: EXPIRED
  â””â”€> Unit A-01-05: RESERVED_BOOKING (not changed)

Step 4: Delete Expired Booking
  â”œâ”€> Check active transactions:
  â”‚   â”œâ”€> Active bookings: 0 âœ“
  â”‚   â”œâ”€> Active reservations: 1 âœ— (reservation still active!)
  â”‚   â””â”€> Active deposits: 0 âœ“
  â”œâ”€> Result: Unit stays RESERVED_BOOKING
  â””â”€> Unit A-01-05: RESERVED_BOOKING (because reservation exists)

Step 5: Complete Reservation
  â”œâ”€> Reservation completed
  â”œâ”€> Check active transactions:
  â”‚   â”œâ”€> Active bookings: 0 âœ“
  â”‚   â”œâ”€> Active reservations: 0 âœ“
  â”‚   â””â”€> Active deposits: 0 âœ“
  â””â”€> Unit A-01-05: AVAILABLE (all transactions cleared)
```

## Status Transition Matrix

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BOOKING STATUS TRANSITIONS                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CONFIRMED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                        â”‚
    â”‚ (time passes)                                          â”‚
    â–¼                                                        â”‚
EXPIRED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚                                                        â”‚
    â”‚ (user clicks trash)                                    â”‚
    â–¼                                                        â”‚
EXPIRED + [HIDDEN_FROM_DASHBOARD] â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ (status never changes after this)
    â–¼
EXPIRED (preserved forever in database)


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UNIT STATUS TRANSITIONS                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AVAILABLE
    â”‚
    â”‚ (booking created)
    â–¼
RESERVED_BOOKING
    â”‚
    â”‚ (booking expires)
    â–¼
RESERVED_BOOKING (stays reserved!)
    â”‚
    â”‚ (user deletes booking + no other active transactions)
    â–¼
AVAILABLE
    â”‚
    â”‚ (new booking created)
    â–¼
RESERVED_BOOKING
    â”‚
    â””â”€> (cycle continues...)
```

## Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DATA FLOW: Dashboard vs Transaction History                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Database (Bookings Table)
    â”‚
    â”œâ”€> BK000001 (status: EXPIRED, notes: "...[HIDDEN_FROM_DASHBOARD]")
    â”œâ”€> BK000002 (status: CONFIRMED, notes: "...")
    â”œâ”€> BK000003 (status: EXPIRED, notes: "...[HIDDEN_FROM_DASHBOARD]")
    â””â”€> BK000004 (status: CONFIRMED, notes: "...")
    
    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                                               â”‚
    â–¼                                                               â–¼
Dashboard Filter                                    Transaction History
(exclude hidden)                                    (show all)
    â”‚                                                               â”‚
    â”œâ”€> BK000002 âœ“                                                 â”œâ”€> BK000001 âœ“
    â””â”€> BK000004 âœ“                                                 â”œâ”€> BK000002 âœ“
                                                                    â”œâ”€> BK000003 âœ“
                                                                    â””â”€> BK000004 âœ“

User Sees:                                          User Sees:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2 Active Bookings   â”‚                            â”‚ 4 Total Bookings    â”‚
â”‚ - BK000002          â”‚                            â”‚ - BK000001 (Expired)â”‚
â”‚ - BK000004          â”‚                            â”‚ - BK000002 (Active) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚ - BK000003 (Expired)â”‚
                                                    â”‚ - BK000004 (Active) â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API Call Sequence

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TYPICAL USER SESSION                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. User Opens Dashboard
   â”œâ”€> GET /api/user/me
   â”œâ”€> POST /api/bookings/check-expired â† Auto-check for expired bookings
   â”œâ”€> GET /api/reservations
   â”œâ”€> GET /api/bookings
   â””â”€> GET /api/deposits

2. User Sees Expired Booking
   â””â”€> Booking displayed with [â± Háº¿t háº¡n] badge and [ðŸ—‘ï¸] button

3. User Clicks Trash Button
   â”œâ”€> Confirmation dialog shown
   â””â”€> User confirms

4. Delete Request Sent
   â””â”€> DELETE /api/bookings/[id]
        â”œâ”€> Verify booking status
        â”œâ”€> Add [HIDDEN_FROM_DASHBOARD] marker
        â”œâ”€> Check active transactions
        â””â”€> Update unit status if safe

5. Dashboard Refreshes
   â”œâ”€> GET /api/bookings (booking now filtered out)
   â””â”€> Booking no longer visible

6. User Checks Transaction History
   â””â”€> GET /api/bookings (all bookings shown)
        â””â”€> Deleted booking still visible with EXPIRED status
```

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ERROR SCENARIOS                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Scenario 1: Try to delete active booking
  User clicks trash on CONFIRMED booking
    â””â”€> API returns 400 error
         â””â”€> "Chá»‰ cÃ³ thá»ƒ áº©n booking Ä‘Ã£ hoÃ n thÃ nh, háº¿t háº¡n hoáº·c Ä‘Ã£ há»§y"

Scenario 2: Booking not found
  User tries to delete non-existent booking
    â””â”€> API returns 404 error
         â””â”€> "KhÃ´ng tÃ¬m tháº¥y booking"

Scenario 3: Database error
  Database connection fails
    â””â”€> API returns 500 error
         â””â”€> "ÄÃ£ xáº£y ra lá»—i khi áº©n booking"
         â””â”€> Transaction rolled back
         â””â”€> No data changed

Scenario 4: Concurrent deletion
  Two users try to delete same booking
    â””â”€> First request succeeds
    â””â”€> Second request fails (booking already hidden)
         â””â”€> Idempotent operation - safe to retry
```

## Performance Optimization

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ QUERY OPTIMIZATION                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Current Queries per Delete:
  1. SELECT booking (verify exists)
  2. UPDATE booking (add hidden marker)
  3. COUNT active bookings
  4. COUNT active reservations
  5. COUNT active deposits
  6. UPDATE unit (if safe)

Total: 6 queries

Optimization Opportunities:
  â”œâ”€> Add indexes on:
  â”‚   â”œâ”€> bookings(unit_id, status)
  â”‚   â”œâ”€> reservations(unit_id, status)
  â”‚   â””â”€> deposits(unit_id, status)
  â”œâ”€> Use database transaction
  â””â”€> Consider caching active counts

Expected Performance:
  â”œâ”€> < 100ms per delete operation
  â”œâ”€> < 500ms for check-expired (batch)
  â””â”€> Scales to 10,000+ bookings
```

---

**Diagram Version:** 1.0.0  
**Last Updated:** November 20, 2025  
**Status:** âœ… Complete and Accurate
