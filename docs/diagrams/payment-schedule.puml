@startuml
!theme plain
title Lá»‹ch Thanh ToÃ¡n (Payment Schedule)

participant "CTV" as ctv
participant "System" as sys
database "DB" as db

== Táº¡o Lá»‹ch Thanh ToÃ¡n (Auto) ==

sys -> sys: Deposit CONFIRMED
sys -> db: Get unit.price = 2,500,000,000
sys -> db: Get deposit.amount = 125,000,000 (5%)

sys -> sys: Generate schedule:

note right
  Äá»£t 1: Cá»c - 5% - 125tr
  Äá»£t 2: 30% - 750tr - 30 days
  Äá»£t 3: 30% - 750tr - 60 days  
  Äá»£t 4: 35% - 875tr - BÃ n giao
end note

sys -> db: INSERT payment_schedules (4 rows)
sys -> db: UPDATE schedule[0]\nstatus = PAID

== Ghi Nháº­n Thanh ToÃ¡n ==

ctv -> sys: Xem lá»‹ch thanh toÃ¡n
sys -> db: Get schedules by depositId
db --> sys: 4 installments
sys --> ctv: Hiá»ƒn thá»‹ table:\n- Äá»£t 1: âœ… ÄÃ£ thanh toÃ¡n\n- Äá»£t 2: â±ï¸ Háº¡n 30/11\n- Äá»£t 3: â±ï¸ Háº¡n 30/12\n- Äá»£t 4: â±ï¸ TBD

ctv -> sys: Click "Thanh toÃ¡n Ä‘á»£t 2"
sys --> ctv: Form:\n- Sá»‘ tiá»n: 750tr\n- NgÃ y TT\n- Upload chá»©ng tá»«

ctv -> sys: Submit
sys -> db: INSERT payments\ninstallment = 2\nstatus = PENDING_CONFIRMATION

actor "Admin" as admin
admin -> sys: XÃ¡c nháº­n payment
sys -> db: UPDATE payments\nstatus = CONFIRMED
sys -> db: UPDATE payment_schedules[1]\nstatus = PAID

sys -> sys: Calculate:\ntotalPaid = sum(payments)\npercentComplete = totalPaid/unitPrice

alt percentComplete >= 100%
    sys -> db: UPDATE units\nstatus = SOLD\nsoldAt = now()
    sys -> sys: Trigger commission
    sys --> ctv: ğŸ‰ CÄƒn Ä‘Ã£ bÃ¡n!\nHoa há»“ng: 50tr
else < 100%
    sys --> ctv: ÄÃ£ nháº­n thanh toÃ¡n\nCÃ²n: X VNÄ
end

@enduml

