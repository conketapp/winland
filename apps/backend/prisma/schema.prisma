generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String           @id @default(uuid())
  phone                String?          @unique
  email                String?          @unique
  password             String
  fullName             String           @map("full_name")
  avatar               String?
  role                 UserRole         @default(CTV)
  isActive             Boolean          @default(true) @map("is_active")
  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")
  totalDeals           Int              @default(0) @map("total_deals")
  deletedAt            DateTime?        @map("deleted_at") // Soft delete
  auditLogs            AuditLog[]
  bookingApprovals     Booking[]        @relation("BookingApprover")
  bookings             Booking[]        @relation("CTVBookings")
  commissions          Commission[]
  depositCancellations Deposit[]        @relation("DepositCanceller")
  depositApprovals     Deposit[]        @relation("DepositApprover")
  deposits             Deposit[]        @relation("CTVDeposits")
  paymentApprovals     PaymentRequest[] @relation("PaymentApprover")
  paymentRequests      PaymentRequest[]
  projectsCreated      Project[]        @relation("ProjectCreator")
  reservations         Reservation[]    @relation("CTVReservations")
  notifications        Notification[]

  @@index([role])
  @@index([role, isActive]) // Composite index for filtering by role and active status
  @@index([isActive])
  @@index([createdAt]) // For sorting
  @@index([deletedAt]) // For soft delete filtering
  @@index([fullName]) // For full-text search
  @@index([phone]) // For full-text search
  @@index([email]) // For full-text search
  @@map("users")
}

model OTP {
  id         String    @id @default(uuid())
  phone      String
  code       String
  purpose    String
  attempts   Int       @default(0)
  expiresAt  DateTime  @map("expires_at")
  verifiedAt DateTime? @map("verified_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  @@index([phone, purpose])
  @@map("otps")
}

model Project {
  id             String        @id @default(uuid())
  name           String
  code           String        @unique
  status         ProjectStatus @default(UPCOMING)
  developer      String
  location       String
  address        String
  district       String
  city           String
  latitude       Float?
  longitude      Float?
  totalArea      Float?        @map("total_area")
  totalBuildings Int?          @map("total_buildings")
  totalUnits     Int?          @map("total_units")
  priceFrom      Float?        @map("price_from")
  priceTo        Float?        @map("price_to")
  description    String?
  amenities      String?
  images         String?
  masterPlan     String?       @map("master_plan")
  floorPlan      String?       @map("floor_plan")
  openDate       DateTime?     @map("open_date")
  commissionRate Float         @default(2.0) @map("commission_rate")
  createdBy      String        @map("created_by")
  deletedAt      DateTime?     @map("deleted_at") // Soft delete
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  buildings      Building[]
  creator        User          @relation("ProjectCreator", fields: [createdBy], references: [id])
  units          Unit[]
  queueProcessingLogs QueueProcessingLog[]

  @@index([code])
  @@index([status, createdAt]) // Composite index for status filtering with sorting
  @@index([city, status]) // Composite index for city + status filtering
  @@index([deletedAt, status]) // Composite index for soft delete + status filtering
  @@index([status])
  @@index([city])
  @@index([deletedAt]) // For soft delete filtering
  @@index([name]) // For full-text search
  @@map("projects")
}

model Building {
  id          String    @id @default(uuid())
  projectId   String    @map("project_id")
  code        String
  name        String
  floors      Int
  description String?
  deletedAt   DateTime? @map("deleted_at") // Soft delete
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  floorsData  Floor[]
  units       Unit[]

  @@unique([projectId, code])
  @@index([projectId])
  @@index([deletedAt]) // For soft delete filtering
  @@index([name]) // For full-text search
  @@map("buildings")
}

model Floor {
  id         String    @id @default(uuid())
  buildingId String    @map("building_id")
  number     Int
  deletedAt  DateTime? @map("deleted_at") // Soft delete
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  building   Building  @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  units      Unit[]

  @@unique([buildingId, number])
  @@index([buildingId])
  @@index([deletedAt]) // For soft delete filtering
  @@map("floors")
}

model Unit {
  id             String        @id @default(uuid())
  projectId      String        @map("project_id")
  buildingId     String        @map("building_id")
  floorId        String        @map("floor_id")
  code           String        @unique
  unitNumber     String        @map("unit_number")
  unitTypeId     String?       @map("unit_type_id")
  status         UnitStatus    @default(AVAILABLE)
  price          Float
  area           Float
  bedrooms       Int?
  bathrooms      Int?
  direction      String?
  balcony        Boolean       @default(false)
  view           String?
  description    String?
  floorPlanImage String?       @map("floor_plan_image")
  images         String?
  commissionRate Float?        @map("commission_rate")
  deletedAt      DateTime?     @map("deleted_at") // Soft delete
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  bookings       Booking[]
  commissions    Commission[]
  deposits       Deposit[]
  reservations   Reservation[]
  unitType       UnitType?     @relation(fields: [unitTypeId], references: [id])
  floor          Floor         @relation(fields: [floorId], references: [id], onDelete: Cascade)
  building       Building      @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  project        Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([projectId, status]) // Composite index for filtering by project and status
  @@index([projectId, status, price]) // Composite index for project + status + price filtering
  @@index([status, createdAt]) // Composite index for status filtering with sorting
  @@index([deletedAt, status]) // Composite index for soft delete + status filtering
  @@index([buildingId])
  @@index([floorId])
  @@index([status])
  @@index([unitTypeId])
  @@index([price]) // For price range queries
  @@index([createdAt]) // For sorting
  @@index([deletedAt]) // For soft delete filtering
  @@index([code]) // For full-text search
  @@index([unitNumber]) // For full-text search
  @@map("units")
}

model UnitType {
  id          String    @id @default(uuid())
  name        String    @unique
  code        String    @unique
  description String?
  deletedAt   DateTime? @map("deleted_at") // Soft delete
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  units       Unit[]

  @@index([deletedAt]) // For soft delete filtering
  @@index([name]) // For full-text search
  @@map("unit_types")
}

model Reservation {
  id              String            @id @default(uuid())
  code            String            @unique
  unitId          String            @map("unit_id")
  ctvId           String            @map("ctv_id")
  customerName    String            @map("customer_name")
  customerPhone   String            @map("customer_phone")
  customerEmail   String?           @map("customer_email")
  notes           String?
  status          ReservationStatus @default(ACTIVE)
  priority        Int               @default(0)
  reservedUntil   DateTime          @map("reserved_until")
  extendCount     Int               @default(0) @map("extend_count")
  cancelledBy     String?           @map("cancelled_by")
  cancelledReason String?           @map("cancelled_reason")
  notifiedAt      DateTime?         @map("notified_at")
  depositDeadline DateTime?         @map("deposit_deadline")
  deletedAt       DateTime?         @map("deleted_at") // Soft delete
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  ctv             User              @relation("CTVReservations", fields: [ctvId], references: [id], onDelete: Cascade)
  unit            Unit              @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId, priority])
  @@index([unitId, status]) // Composite index for filtering by unit and status
  @@index([ctvId, status]) // Composite index for CTV's reservations by status
  @@index([ctvId, status, createdAt]) // Composite index for CTV's reservations with sorting
  @@index([status, createdAt]) // Composite index for status filtering with sorting
  @@index([deletedAt, status]) // Composite index for soft delete + status filtering
  @@index([ctvId])
  @@index([status])
  @@index([code])
  @@index([reservedUntil]) // For expiry checks
  @@index([depositDeadline]) // For queue processing
  @@index([createdAt]) // For sorting
  @@index([deletedAt]) // For soft delete filtering
  @@index([customerName]) // For full-text search
  @@index([customerPhone]) // For full-text search
  @@map("reservations")
}

model Booking {
  id              String        @id @default(uuid())
  code            String        @unique
  unitId          String        @map("unit_id")
  ctvId           String        @map("ctv_id")
  customerName    String        @map("customer_name")
  customerPhone   String        @map("customer_phone")
  customerEmail   String?       @map("customer_email")
  bookingAmount   Float         @map("booking_amount")
  paymentMethod   String        @default("BANK_TRANSFER") @map("payment_method")
  paymentProof    String?       @map("payment_proof")
  status          BookingStatus @default(PENDING_APPROVAL)
  expiresAt       DateTime      @map("expires_at")
  approvedBy      String?       @map("approved_by")
  approvedAt      DateTime?     @map("approved_at")
  cancelledReason String?       @map("cancelled_reason")
  refundAmount    Float?        @map("refund_amount")
  notes           String?
  deletedAt       DateTime?     @map("deleted_at") // Soft delete
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  approver        User?         @relation("BookingApprover", fields: [approvedBy], references: [id])
  ctv             User          @relation("CTVBookings", fields: [ctvId], references: [id], onDelete: Cascade)
  unit            Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@index([unitId, status]) // Composite index for filtering by unit and status
  @@index([ctvId, status]) // Composite index for CTV's bookings by status
  @@index([ctvId, status, createdAt]) // Composite index for CTV's bookings with sorting
  @@index([status, createdAt]) // Composite index for status filtering with sorting
  @@index([deletedAt, status]) // Composite index for soft delete + status filtering
  @@index([status, expiresAt]) // Composite index for status + expiry checks
  @@index([ctvId])
  @@index([status])
  @@index([code])
  @@index([expiresAt]) // For expiry checks
  @@index([createdAt]) // For sorting
  @@index([deletedAt]) // For soft delete filtering
  @@index([customerName]) // For full-text search
  @@index([customerPhone]) // For full-text search
  @@map("bookings")
}

model Deposit {
  id                String            @id @default(uuid())
  code              String            @unique
  unitId            String            @map("unit_id")
  ctvId             String            @map("ctv_id")
  customerName      String            @map("customer_name")
  customerPhone     String            @map("customer_phone")
  customerEmail     String?           @map("customer_email")
  customerIdCard    String            @map("customer_id_card")
  customerAddress   String            @map("customer_address")
  depositAmount     Float             @map("deposit_amount")
  depositPercentage Float             @map("deposit_percentage")
  depositDate       DateTime          @map("deposit_date")
  paymentMethod     String            @default("BANK_TRANSFER") @map("payment_method")
  paymentProof      String?           @map("payment_proof")
  contractUrl       String?           @map("contract_url")
  finalPrice        Float?            @map("final_price") // Giá thực tế chốt deal (sau chiết khấu)
  status            DepositStatus     @default(PENDING_APPROVAL)
  approvedBy        String?           @map("approved_by")
  approvedAt        DateTime?         @map("approved_at")
  cancelledBy       String?           @map("cancelled_by")
  cancelledReason   String?           @map("cancelled_reason")
  refundAmount      Float?            @map("refund_amount")
  notes             String?
  deletedAt         DateTime?         @map("deleted_at") // Soft delete
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  commissions       Commission?
  canceller         User?             @relation("DepositCanceller", fields: [cancelledBy], references: [id])
  approver          User?             @relation("DepositApprover", fields: [approvedBy], references: [id])
  ctv               User              @relation("CTVDeposits", fields: [ctvId], references: [id], onDelete: Cascade)
  unit              Unit              @relation(fields: [unitId], references: [id], onDelete: Cascade)
  paymentSchedules  PaymentSchedule[]
  transactions      Transaction[]

  @@index([unitId])
  @@index([unitId, status]) // Composite index for filtering by unit and status
  @@index([ctvId, status]) // Composite index for CTV's deposits by status
  @@index([ctvId, status, createdAt]) // Composite index for CTV's deposits with sorting
  @@index([status, createdAt]) // Composite index for status filtering with sorting
  @@index([deletedAt, status]) // Composite index for soft delete + status filtering
  @@index([ctvId])
  @@index([status])
  @@index([code])
  @@index([createdAt]) // For sorting
  @@index([deletedAt]) // For soft delete filtering
  @@index([customerName]) // For full-text search
  @@index([customerPhone]) // For full-text search
  @@index([customerIdCard]) // For full-text search
  @@map("deposits")
}

model PaymentSchedule {
  id           String                @id @default(uuid())
  depositId    String                @map("deposit_id")
  installment  Int
  name         String
  percentage   Float
  amount       Float
  dueDate      DateTime?             @map("due_date")
  status       PaymentScheduleStatus @default(PENDING)
  paidAmount   Float                 @default(0) @map("paid_amount")
  paidAt       DateTime?             @map("paid_at")
  deletedAt    DateTime?             @map("deleted_at") // Soft delete
  createdAt    DateTime              @default(now()) @map("created_at")
  updatedAt    DateTime              @updatedAt @map("updated_at")
  deposit      Deposit               @relation(fields: [depositId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([depositId])
  @@index([depositId, status]) // Composite index for filtering by deposit and status
  @@index([status, dueDate]) // Composite index for status + overdue checks
  @@index([status, dueDate, createdAt]) // Composite index for status + dueDate + sorting
  @@index([deletedAt, status]) // Composite index for soft delete + status filtering
  @@index([status])
  @@index([dueDate]) // For overdue checks
  @@index([deletedAt]) // For soft delete filtering
  @@map("payment_schedules")
}

model Transaction {
  id                String            @id @default(uuid())
  depositId         String            @map("deposit_id")
  paymentScheduleId String?           @map("payment_schedule_id")
  amount            Float
  paymentDate       DateTime          @map("payment_date")
  paymentMethod     String            @default("BANK_TRANSFER") @map("payment_method")
  paymentProof      String?           @map("payment_proof")
  transactionRef    String?           @map("transaction_ref")
  status            TransactionStatus @default(PENDING_CONFIRMATION)
  confirmedAt       DateTime?         @map("confirmed_at")
  notes             String?
  deletedAt         DateTime?         @map("deleted_at") // Soft delete
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")
  paymentSchedule   PaymentSchedule?  @relation(fields: [paymentScheduleId], references: [id])
  deposit           Deposit           @relation(fields: [depositId], references: [id], onDelete: Cascade)

  @@index([depositId])
  @@index([depositId, status]) // Composite index for filtering by deposit and status
  @@index([depositId, status, paymentDate]) // Composite index for deposit + status + date range
  @@index([paymentScheduleId])
  @@index([paymentScheduleId, status]) // Composite index for payment schedule transactions
  @@index([status, paymentDate]) // Composite index for status + date range queries
  @@index([status, createdAt]) // Composite index for status filtering with sorting
  @@index([deletedAt, status]) // Composite index for soft delete + status filtering
  @@index([status])
  @@index([paymentDate]) // For date range queries
  @@index([createdAt]) // For sorting
  @@index([deletedAt]) // For soft delete filtering
  @@index([transactionRef]) // For full-text search
  @@map("transactions")
}

model Commission {
  id              String           @id @default(uuid())
  unitId          String           @map("unit_id")
  ctvId           String           @map("ctv_id")
  depositId       String           @unique @map("deposit_id")
  amount          Float
  rate            Float
  calculationBase String           @default("final_price") @map("calculation_base") // "final_price" | "list_price"
  basePrice       Float            @map("base_price") // Giá dùng để tính (finalPrice hoặc listPrice)
  status          CommissionStatus @default(PENDING)
  paidAt          DateTime?        @map("paid_at")
  deletedAt       DateTime?        @map("deleted_at") // Soft delete
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")
  deposit         Deposit          @relation(fields: [depositId], references: [id], onDelete: Cascade)
  ctv             User             @relation(fields: [ctvId], references: [id], onDelete: Cascade)
  unit            Unit             @relation(fields: [unitId], references: [id], onDelete: Cascade)
  paymentRequests PaymentRequest[]

  @@index([unitId])
  @@index([ctvId, status]) // Composite index for CTV's commissions by status
  @@index([ctvId, status, createdAt]) // Composite index for CTV's commissions with sorting
  @@index([status, createdAt]) // Composite index for status filtering with sorting
  @@index([deletedAt, status]) // Composite index for soft delete + status filtering
  @@index([ctvId])
  @@index([status])
  @@index([deletedAt]) // For soft delete filtering
  @@map("commissions")
}

model PaymentRequest {
  id              String               @id @default(uuid())
  commissionId    String               @map("commission_id")
  ctvId           String               @map("ctv_id")
  amount          Float
  bankName        String?              @map("bank_name")
  bankAccount     String?              @map("bank_account")
  bankAccountName String?              @map("bank_account_name")
  status          PaymentRequestStatus @default(PENDING)
  requestedAt     DateTime             @default(now()) @map("requested_at")
  approvedBy      String?              @map("approved_by")
  approvedAt      DateTime?            @map("approved_at")
  rejectedReason  String?              @map("rejected_reason")
  notes           String?
  deletedAt       DateTime?            @map("deleted_at") // Soft delete
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  approver        User?                @relation("PaymentApprover", fields: [approvedBy], references: [id])
  ctv             User                 @relation(fields: [ctvId], references: [id], onDelete: Cascade)
  commission      Commission           @relation(fields: [commissionId], references: [id], onDelete: Cascade)

  @@index([commissionId])
  @@index([ctvId, status]) // Composite index for CTV's payment requests by status
  @@index([ctvId, status, createdAt]) // Composite index for CTV's payment requests with sorting
  @@index([status, createdAt]) // Composite index for status filtering with sorting
  @@index([deletedAt, status]) // Composite index for soft delete + status filtering
  @@index([ctvId])
  @@index([status])
  @@index([deletedAt]) // For soft delete filtering
  @@index([bankAccount]) // For full-text search
  @@map("payment_requests")
}

model SystemConfig {
  id          String    @id @default(uuid())
  key         String    @unique
  value       String
  type        String
  label       String
  category    String
  description String?
  editableBy  String    @default("ADMIN") @map("editable_by")
  deletedAt   DateTime? @map("deleted_at") // Soft delete
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([category])
  @@index([key])
  @@index([deletedAt]) // For soft delete filtering
  @@index([label]) // For full-text search
  @@map("system_configs")
}

model PdfTemplate {
  id          String    @id @default(uuid())
  type        String
  name        String
  templateUrl String?   @map("template_url")
  variables   String?
  isDefault   Boolean   @default(false) @map("is_default")
  isActive    Boolean   @default(true) @map("is_active")
  deletedAt   DateTime? @map("deleted_at") // Soft delete
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([type])
  @@index([deletedAt]) // For soft delete filtering
  @@index([name]) // For full-text search
  @@map("pdf_templates")
}

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?  @map("user_id")
  action     String
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  oldValue   String?  @map("old_value")
  newValue   String?  @map("new_value")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([userId, createdAt]) // Composite index for user's audit logs with sorting
  @@index([entityType, entityId])
  @@index([action, createdAt]) // Composite index for action filtering with sorting
  @@index([entityType, createdAt]) // Composite index for entity type filtering with sorting
  @@index([action])
  @@index([createdAt])
  @@index([entityType]) // For full-text search
  @@index([entityId]) // For full-text search
  @@map("audit_logs")
}

model Notification {
  id            String                @id @default(uuid())
  userId        String                @map("user_id")
  type          NotificationType      @map("type")
  title         String
  message       String
  entityType    String?               @map("entity_type")
  entityId      String?               @map("entity_id")
  metadata      String?               @map("metadata")
  channel       NotificationChannel   @default(IN_APP)
  status        NotificationStatus    @default(PENDING) // PENDING, SENT, FAILED, QUEUED
  isRead        Boolean               @default(false) @map("is_read")
  readAt        DateTime?             @map("read_at")
  sentAt        DateTime?             @map("sent_at")
  failedAt      DateTime?             @map("failed_at")
  errorMessage  String?               @map("error_message")
  retryCount    Int                   @default(0) @map("retry_count")
  nextRetryAt   DateTime?             @map("next_retry_at")
  deletedAt     DateTime?             @map("deleted_at") // Soft delete
  createdAt     DateTime              @default(now()) @map("created_at")
  updatedAt     DateTime              @updatedAt @map("updated_at")
  user          User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([userId, isRead, createdAt]) // Composite index for user's notifications with sorting
  @@index([userId, status]) // For filtering by user and status
  @@index([status, nextRetryAt]) // For finding notifications to retry
  @@index([entityType, entityId])
  @@index([deletedAt, isRead]) // Composite index for soft delete + read status
  @@index([deletedAt]) // For soft delete filtering
  @@index([status]) // For filtering by status
  @@index([title]) // For full-text search
  @@map("notifications")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  CTV
  USER
}

enum ProjectStatus {
  UPCOMING
  OPEN
  CLOSED
}

enum UnitStatus {
  AVAILABLE
  RESERVED_BOOKING
  DEPOSITED
  SOLD
}

enum ReservationStatus {
  ACTIVE
  YOUR_TURN
  MISSED
  EXPIRED
  CANCELLED
  COMPLETED
}

enum BookingStatus {
  PENDING_PAYMENT
  PENDING_APPROVAL
  CONFIRMED
  CANCELLED
  EXPIRED
  UPGRADED
}

enum DepositStatus {
  PENDING_APPROVAL
  CONFIRMED
  OVERDUE
  CANCELLED
  COMPLETED
}

enum PaymentScheduleStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum TransactionStatus {
  PENDING_CONFIRMATION
  CONFIRMED
  CANCELLED
}

enum CommissionStatus {
  PENDING
  APPROVED
  PAID
}

enum PaymentRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  RESERVATION_CREATED
  RESERVATION_YOUR_TURN
  RESERVATION_EXPIRED
  RESERVATION_MISSED
  BOOKING_CREATED
  BOOKING_APPROVED
  BOOKING_REJECTED
  BOOKING_CANCELLED
  BOOKING_EXPIRED
  DEPOSIT_CREATED
  DEPOSIT_APPROVED
  DEPOSIT_CANCELLED
  DEPOSIT_OVERDUE
  PAYMENT_OVERDUE
  PAYMENT_CONFIRMED
  UNIT_SOLD
  COMMISSION_CREATED
  PAYMENT_REQUEST_CREATED
  PAYMENT_REQUEST_APPROVED
  PAYMENT_REQUEST_REJECTED
  QUEUE_PROCESSING_ERRORS
  QUEUE_PROCESSING_COMPLETE
}

enum NotificationChannel {
  IN_APP
  SMS
  EMAIL
}

enum NotificationStatus {
  PENDING  // Just created, not sent yet
  QUEUED   // Queued for retry
  SENT     // Successfully sent
  FAILED   // Failed after max retries
}

model Sequence {
  id        String   @id @default(uuid())
  type      String   @unique // "RESERVATION", "BOOKING", "DEPOSIT"
  current   Int      @default(0) // Current sequence number
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("sequences")
}

model QueueProcessingLog {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  status      String   // "PROCESSING" | "COMPLETED" | "FAILED" | "PARTIAL"
  totalUnits  Int      @map("total_units")
  processed   Int      @default(0)
  skipped     Int      @default(0)
  failed      Int      @default(0)
  failedUnits String?  @map("failed_units") // JSON array of { unitId, error }
  errorMessage String? @map("error_message")
  startedAt   DateTime @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  retryCount  Int      @default(0) @map("retry_count")
  deletedAt   DateTime? @map("deleted_at") // Soft delete
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
  @@index([status, createdAt]) // For filtering by status with sorting
  @@index([deletedAt])
  @@index([createdAt])
  @@map("queue_processing_logs")
}
